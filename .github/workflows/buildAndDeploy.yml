name: Cass Config Builder Build & Deploy
on:
  push:
    branches: [ master, multiarch-pr ]
  pull_request:
    branches: [ master, multiarch-pr ]
jobs:
  build_operator_docker:
    name: Build Cass Config Builder Docker Image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        if: github.event_name == 'pull_request'
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          submodules: true
      - uses: actions/checkout@v2
        if: github.event_name != 'pull_request'
        with:
          submodules: true
      - name: Setup Buildx
        id: buildx
        uses: crazy-max/ghaction-docker-buildx@v3
        with:
          version: latest
      - name: Login to GitHub Package Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u "${{ github.actor }}" --password-stdin
      - name: Build docker image
        run: |
          echo "Repo owner: ${{ github.repository_owner	}}"
          echo "Actor: ${{ github.repository_owner }}"
          VERSION_NUMBER="$(cat version.txt | tr -d '[:space:]')"
          echo "Version: $VERSION_NUMBER"
          VERSION_DATE="$(date -u +%Y%m%d)"
          echo "Date: $VERSION_DATE"
          RELEASE_VERSION="${VERSION_NUMBER}-${VERSION_DATE}"
          echo "Release: $RELEASE_VERSION"
          # docker buildx build --push \
          #   --tag docker.pkg.github.com/johntrimble/cass-config-builder/cass-config-builder:$RELEASE_VERSION \
          #   --label "release=${RELEASE_VERSION}" \
          #   --file docker/debian.Dockerfile \
          #   --target cass-config-builder \
          #   --platform linux/amd64,linux/arm64 .
